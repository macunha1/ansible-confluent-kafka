---

language: python
python: "2.7"
before_install:
 - sudo apt-get update -qq
 - sudo apt-get install -qq python-apt python-pycurl
 - sudo groupadd -g 995 nobody
 - sudo useradd -r -u 995 -g nobody nobody || true

matrix:
  include:
    - python: '3.5' # this is not strictly necessary
      env: EXTRA_TESTS=true
    - python: '2.7'
      env: EXTRA_TESTS=true

install:
  - pip install ansible==2.6.2

script:
  # Install Ansible playbook requirements (dependencies)
  - ansible-galaxy install -r requirements.yml
  # Check code style and syntax
  - ansible-playbook --syntax-check -i inventory test.yml
  # First run to install
  - ansible-playbook -i inventory test.yml --connection=local --become

  # Second run Idempotence test
  - >
     ansible-playbook -i inventory test.yml --connection=local --become
     | grep -q 'changed=0.*failed=0'
     && (echo 'Idempotence test: pass' && exit 0)
     || (echo 'Idempotence test: fail' && exit 1)

