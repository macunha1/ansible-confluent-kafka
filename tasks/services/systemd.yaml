---
- name: Systemd | Create Init script for services
  ansible.builtin.template:
    src: service.j2
    dest: "{{ initscripts_path }}/{{ confluent_service.value.file_name }}"
    mode: 0751
    force: true
  become: true
  vars:
    service_name: "{{ confluent_service.key }}"
    daemon_start: "{{ confluent_service.value.daemon_start }}"
    daemon_opts: "{{ confluent_service.value.daemon_opts }}"
    daemon_stop: "{{ confluent_service.value.daemon_stop }}"
    daemon_status: "{{ confluent_service.value.daemon_status }}"

  loop: "{{ services | dict2items }}"
  loop_control:
    loop_var: confluent_service

- name: System Users | Change Init script ownership
  ansible.builtin.file:
    path: "{{ initscripts_path }}/{{ confluent_service.value.file_name }}"
    owner: "{{ confluent_service.value.user }}"
    group: "{{ kafka_system_users.group }}"
    force: true
  become: true

  loop: "{{ services | dict2items }}"
  loop_control:
    loop_var: confluent_service

  when: kafka_system_users.enabled

- name: System Users | Render environment file from template
  ansible.builtin.template:
    src: "{{ item.template }}"
    dest: "{{ confluent_kafka_env_file_path }}/{{ item.name }}"
    mode: 0755
    force: true

  loop:
    - template: "kafka-env.sh.j2"
      name: "kafka-env.sh"
      group: "{{ groups['kafka'] }}"

    - template: "zookeeper-env.sh.j2"
      name: "zookeeper-env.sh"
      group: "{{ groups['zookeeper'] }}"

  when:
    - item.group is defined
    - inventory_hostname in item.group

- name: System Users | Change environment file ownership
  ansible.builtin.file:
    path: "{{ confluent_kafka_env_file_path }}/{{ item.name }}"
    owner: "{{ item.owner }}"
    mode: "{{ kafka_system_users.permissions.directory_mode }}"
    group: "{{ kafka_system_users.group }}"
    force: true

  loop:
    - owner: "kafka"
      name: "kafka-env.sh"
      group: "{{ groups['kafka'] }}"

    - owner: "zookeeper"
      name: "zookeeper-env.sh"
      group: "{{ groups['zookeeper'] }}"

  when:
    - kafka_system_users.enabled
    - item.group is defined
    - inventory_hostname in item.group

- name: Systemd | Create services unit
  ansible.builtin.template:
    src: systemd.service.j2
    dest: "/etc/systemd/system/{{ confluent_service.key }}.service"
    mode: 0640
    force: true

  vars:
    service_name: "{{ confluent_service.key }}"
    file_name: "{{ confluent_service.value.file_name }}"
    environment_file: "{{ confluent_service.value.environment_file }}"
    limit_nofile: "{{ confluent_service.value.limit_nofile }}"
    limit_nproc: "{{ confluent_service.value.limit_nproc }}"

  loop: "{{ services | dict2items }}"
  loop_control:
    loop_var: confluent_service

  become: true

- name: System Users | Change service unit ownership
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ confluent_service.key }}.service"
    mode: 0640
    group: "{{ kafka_system_users.group }}"
    force: yes

  loop: "{{ services | dict2items }}"
  loop_control:
    loop_var: confluent_service

  when: kafka_system_users.enabled

- name: Systemd | Reload daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Systemd | Configure service
  ansible.builtin.systemd:
    name: "{{ item.key }}"
    state: "{{ item.value.state | default('started') }}"
    enabled: "{{ item.value.enabled | default(true) }}"

  loop: "{{ services | dict2items }}"
  loop_control:
    loop_var: confluent_service

  register: result
  until: result is succeeded
  retries: 3
  ignore_errors: yes
